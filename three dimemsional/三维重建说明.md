# å¢å¼ºçš„ä¸‰ç»´é‡å»ºç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªé›†æˆäº†ç²’å­ç¾¤ä¼˜åŒ–ç®—æ³•çš„å¢å¼ºä¸‰ç»´é‡å»ºç³»ç»Ÿï¼ŒåŸºäºç»“æ„å…‰ç›¸ä½å›¾å’Œç›¸æœº/æŠ•å½±ä»ªæ ‡å®šå‚æ•°ç”Ÿæˆé«˜è´¨é‡çš„ä¸‰ç»´ç‚¹äº‘ã€‚è¯¥ç³»ç»Ÿç»“åˆäº†ä¼ ç»Ÿä¸‰è§’æµ‹é‡æ–¹æ³•å’Œç°ä»£ä¼˜åŒ–ç®—æ³•ï¼Œæä¾›äº†é«˜ç²¾åº¦ã€é«˜æ•ˆç‡çš„ä¸‰ç»´é‡å»ºè§£å†³æ–¹æ¡ˆã€‚

## ğŸš€ ä¸»è¦ç‰¹æ€§

- **ğŸ”¬ å¤šç§é‡å»ºç®—æ³•**:
  - ç²’å­ç¾¤ä¼˜åŒ–ç®—æ³•ï¼ˆPSOï¼‰- é«˜ç²¾åº¦æ·±åº¦ä¼°è®¡
  - å‘é‡åŒ–ä¸‰è§’æµ‹é‡ - é«˜æ•ˆç‡æ‰¹é‡å¤„ç†
  - æ ‡å‡†SVDä¸‰è§’æµ‹é‡ - ç¨³å®šå¯é çš„åŸºç¡€ç®—æ³•

- **âš¡ æ€§èƒ½ä¼˜åŒ–**:
  - å‘é‡åŒ–è®¡ç®—æé«˜å¤„ç†é€Ÿåº¦
  - æ‰¹é‡å¤„ç†å‡å°‘å†…å­˜å ç”¨
  - å¤šçº¿ç¨‹æ”¯æŒï¼ˆå¯æ‰©å±•ï¼‰

- **ğŸ¯ é«˜è´¨é‡é‡å»º**:
  - æ™ºèƒ½æ©ç ç”Ÿæˆå’Œè¿‡æ»¤
  - ç»Ÿè®¡å™ªå£°å»é™¤
  - å¤šç§ç½‘æ ¼é‡å»ºæ–¹æ³•ï¼ˆæ³Šæ¾é‡å»ºã€Alpha Shapeï¼‰

- **ğŸ”§ çµæ´»çš„ä½¿ç”¨æ–¹å¼**:
  - å‘½ä»¤è¡Œç•Œé¢
  - äº¤äº’å¼ç•Œé¢
  - APIæ¥å£ä¾›å…¶ä»–ç¨‹åºè°ƒç”¨

- **ğŸ“Š è¯¦ç»†çš„è´¨é‡è¯„ä¼°**:
  - é‡å»ºè´¨é‡è¯„åˆ†
  - ç»Ÿè®¡åˆ†ææŠ¥å‘Š
  - å¯è§†åŒ–è´¨é‡åˆ†å¸ƒ

- **ğŸ’¾ å¤šæ ¼å¼æ”¯æŒ**:
  - ç›¸ä½å›¾æ ¼å¼ï¼š.npy, .png, .jpg, .tiffç­‰
  - å‚æ•°æ–‡ä»¶ï¼š.json, .npy
  - è¾“å‡ºæ ¼å¼ï¼š.plyç‚¹äº‘å’Œç½‘æ ¼æ–‡ä»¶

## ğŸ”¬ æŠ€æœ¯åŸç†

### ç»“æ„å…‰ä¸‰ç»´é‡å»ºåŸºç¡€

ç»“æ„å…‰ä¸‰ç»´é‡å»ºæ˜¯ä¸€ç§ä¸»åŠ¨å¼ä¸‰ç»´æµ‹é‡æŠ€æœ¯ï¼Œé€šè¿‡æŠ•å½±å·²çŸ¥å›¾æ¡ˆåˆ°ç‰©ä½“è¡¨é¢ï¼Œåˆ†æå›¾æ¡ˆçš„å˜å½¢æ¥é‡å»ºç‰©ä½“çš„ä¸‰ç»´å½¢çŠ¶ã€‚

#### 1. ç›¸ä½è§£åŒ…è£¹

- **è¾“å…¥**: ç»è¿‡ç›¸ä½è§£åŒ…è£¹å¤„ç†çš„Xå’ŒYæ–¹å‘ç›¸ä½å›¾
- **åŸç†**: ç›¸ä½å€¼ç›´æ¥å¯¹åº”æŠ•å½±ä»ªä¸Šçš„åƒç´ åæ ‡
- **å…¬å¼**: `proj_x = phase_x * projector_width / (2Ï€)`

#### 2. ä¸‰è§’æµ‹é‡åŸç†

åŸºäºç›¸æœº-æŠ•å½±ä»ªçš„ç«‹ä½“è§†è§‰å‡ ä½•å…³ç³»ï¼š

```bash
ç›¸æœºå°„çº¿: P_cam = K_cam^(-1) * [u, v, 1]^T * depth
æŠ•å½±ä»ªå°„çº¿: P_proj = R * (K_proj^(-1) * [u_p, v_p, 1]^T * depth_p) + T
çº¦æŸæ¡ä»¶: P_cam = P_proj (åŒä¸€ç©ºé—´ç‚¹)
```

å…¶ä¸­ï¼š

- `K_cam`, `K_proj`: ç›¸æœºå’ŒæŠ•å½±ä»ªå†…å‚çŸ©é˜µ
- `R`, `T`: æŠ•å½±ä»ªåˆ°ç›¸æœºçš„æ—‹è½¬å’Œå¹³ç§»
- `[u, v]`, `[u_p, v_p]`: ç›¸æœºå’ŒæŠ•å½±ä»ªåƒç´ åæ ‡

#### 3. ç²’å­ç¾¤ä¼˜åŒ–ï¼ˆPSOï¼‰

ä¼ ç»Ÿä¸‰è§’æµ‹é‡å¯èƒ½å—å™ªå£°å½±å“ï¼ŒPSOé€šè¿‡ä¼˜åŒ–æ·±åº¦å€¼æ¥æœ€å°åŒ–é‡æŠ•å½±è¯¯å·®ï¼š

```bash
ç›®æ ‡å‡½æ•°: minimize ||P_cam_reproj - P_cam_observed||Â² + ||P_proj_reproj - P_proj_observed||Â²
```

PSOç®—æ³•ç‰¹ç‚¹ï¼š

- **å…¨å±€æœç´¢èƒ½åŠ›**: é¿å…å±€éƒ¨æœ€ä¼˜è§£
- **è‡ªé€‚åº”å‚æ•°**: åŠ¨æ€è°ƒæ•´æœç´¢ç­–ç•¥
- **é²æ£’æ€§å¼º**: å¯¹å™ªå£°å’Œå¼‚å¸¸å€¼ä¸æ•æ„Ÿ

### ç®—æ³•æµç¨‹

1. **é¢„å¤„ç†é˜¶æ®µ**
   - åŠ è½½ç›¸æœº/æŠ•å½±ä»ªæ ‡å®šå‚æ•°
   - è¯»å–è§£åŒ…è£¹ç›¸ä½å›¾
   - ç”Ÿæˆæœ‰æ•ˆåŒºåŸŸæ©ç 

2. **ä¸‰ç»´é‡å»ºé˜¶æ®µ**
   - ç›¸ä½åˆ°æŠ•å½±ä»ªåæ ‡è½¬æ¢
   - é€‰æ‹©é‡å»ºç®—æ³•ï¼ˆPSO/å‘é‡åŒ–ä¸‰è§’æµ‹é‡ï¼‰
   - é€ç‚¹æˆ–æ‰¹é‡è®¡ç®—ä¸‰ç»´åæ ‡

3. **åå¤„ç†é˜¶æ®µ**
   - ç‚¹äº‘è´¨é‡è¿‡æ»¤
   - ç»Ÿè®¡å™ªå£°å»é™¤
   - ç½‘æ ¼é‡å»ºï¼ˆå¯é€‰ï¼‰

4. **ç»“æœè¾“å‡º**
   - ä¿å­˜ç‚¹äº‘å’Œç½‘æ ¼æ–‡ä»¶
   - ç”Ÿæˆè´¨é‡è¯„ä¼°æŠ¥å‘Š
   - å¯è§†åŒ–ç»“æœ

## ğŸ’» ç³»ç»Ÿè¦æ±‚

### åŸºç¡€ä¾èµ–

```bash
pip install numpy opencv-python matplotlib open3d scipy
```

### å¯é€‰ä¾èµ–ï¼ˆç”¨äºæ€§èƒ½ä¼˜åŒ–ï¼‰

```bash
pip install numba  # JITç¼–è¯‘åŠ é€Ÿ
pip install joblib  # å¹¶è¡Œå¤„ç†
```

## ä½¿ç”¨æ–¹æ³•

### 1. äº¤äº’å¼æ¨¡å¼

ç›´æ¥è¿è¡Œè„šæœ¬ï¼Œç³»ç»Ÿä¼šå¼•å¯¼æ‚¨è¾“å…¥æ‰€éœ€å‚æ•°ï¼š

```bash
python enhanced_3d_reconstruction.py
```

### 2. å‘½ä»¤è¡Œæ¨¡å¼

ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ç›´æ¥æŒ‡å®šæ‰€æœ‰å‚æ•°ï¼š

```bash
python enhanced_3d_reconstruction.py \
    --camera-params camera_params.json \
    --projector-params projector_params.json \
    --extrinsics extrinsics.json \
    --phase-x phase_x.npy \
    --phase-y phase_y.npy \
    --output-dir output \
    --use-pso \
    --step-size 5 \
    --mask-percentile 98.0 \
    --create-mesh
```

## å‚æ•°è¯´æ˜

- `--camera-params`: ç›¸æœºå†…å‚æ–‡ä»¶è·¯å¾„ï¼ˆ.npyæˆ–.jsonæ ¼å¼ï¼‰
- `--projector-params`: æŠ•å½±ä»ªå†…å‚æ–‡ä»¶è·¯å¾„ï¼ˆ.npyæˆ–.jsonæ ¼å¼ï¼‰
- `--extrinsics`: ç›¸æœºå’ŒæŠ•å½±ä»ªä¹‹é—´çš„å¤–å‚æ–‡ä»¶è·¯å¾„ï¼ˆ.npyæˆ–.jsonæ ¼å¼ï¼‰
- `--phase-x`: Xæ–¹å‘è§£åŒ…è£¹ç›¸ä½æ–‡ä»¶è·¯å¾„
- `--phase-y`: Yæ–¹å‘è§£åŒ…è£¹ç›¸ä½æ–‡ä»¶è·¯å¾„
- `--output-dir`: è¾“å‡ºç›®å½•è·¯å¾„
- `--use-pso`: å¯ç”¨ç²’å­ç¾¤ä¼˜åŒ–ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
- `--no-pso`: ç¦ç”¨ç²’å­ç¾¤ä¼˜åŒ–ï¼Œä½¿ç”¨ç®€åŒ–ä¸‰è§’æµ‹é‡
- `--step-size`: é‡‡æ ·æ­¥é•¿ï¼Œå€¼è¶Šå°ç²¾åº¦è¶Šé«˜ä½†è®¡ç®—è¶Šæ…¢ï¼ˆé»˜è®¤ï¼š5ï¼‰
- `--mask-percentile`: æ©ç é˜ˆå€¼çš„ç™¾åˆ†ä½æ•°ï¼ˆé»˜è®¤ï¼š98.0ï¼‰
- `--create-mesh`: ä»ç‚¹äº‘åˆ›å»ºç½‘æ ¼ï¼ˆé»˜è®¤å¯ç”¨ï¼‰

## ğŸ”Œ APIæ¥å£ä½¿ç”¨

### åŸºç¡€APIä½¿ç”¨

```python
from enhanced_3d_reconstruction import Enhanced3DReconstructionAPI

# åˆ›å»ºAPIå®ä¾‹
api = Enhanced3DReconstructionAPI()

# åˆå§‹åŒ–ç³»ç»Ÿ
success = api.initialize(
    camera_params_file="camera_params.json",
    projector_params_file="projector_params.json",
    extrinsics_file="extrinsics.json"
)

if success:
    # ä»æ–‡ä»¶è¿›è¡Œé‡å»º
    result = api.reconstruct_from_files(
        phase_x_file="phase_x.npy",
        phase_y_file="phase_y.npy",
        output_dir="output",
        use_pso=True,
        step_size=5
    )

    if result["success"]:
        print(f"é‡å»ºæˆåŠŸï¼ç”Ÿæˆäº† {result['stats']['filtered_points']} ä¸ªç‚¹")
        print(f"å¹³å‡è´¨é‡è¯„åˆ†: {result['stats']['average_quality']:.3f}")
    else:
        print(f"é‡å»ºå¤±è´¥: {result['error']}")
```

### é«˜çº§APIä½¿ç”¨

```python
import numpy as np
from enhanced_3d_reconstruction import Enhanced3DReconstructionAPI

# åˆ›å»ºAPIå®ä¾‹
api = Enhanced3DReconstructionAPI()

# åˆå§‹åŒ–
api.initialize("camera.json", "projector.json", "extrinsics.json")

# ä»æ•°ç»„è¿›è¡Œé‡å»º
phase_x = np.load("phase_x.npy")
phase_y = np.load("phase_y.npy")

result = api.reconstruct_from_arrays(
    phase_x, phase_y,
    use_pso=False,  # ä½¿ç”¨å¿«é€Ÿå‘é‡åŒ–æ–¹æ³•
    step_size=3     # é«˜ç²¾åº¦é‡‡æ ·
)

if result["success"]:
    # è·å–é‡å»ºç»“æœ
    points = result["points"]
    colors = result["colors"]
    pointcloud = result["pointcloud"]

    # è·å–è´¨é‡è¯„ä¼°
    quality_report = api.get_reconstruction_quality(
        points, [0.5] * len(points)  # ç¤ºä¾‹è´¨é‡è¯„åˆ†
    )

    print("è´¨é‡æŠ¥å‘Š:")
    print(f"- ç‚¹äº‘æ•°é‡: {quality_report['point_count']}")
    print(f"- æ·±åº¦èŒƒå›´: {quality_report['depth_range']['min']:.1f} - {quality_report['depth_range']['max']:.1f} mm")
    print(f"- å¹³å‡æ·±åº¦: {quality_report['depth_range']['mean']:.1f} mm")
```

### é›†æˆåˆ°å…¶ä»–é¡¹ç›®

```python
# åœ¨æ‚¨çš„é¡¹ç›®ä¸­ä½¿ç”¨
class MyVisionSystem:
    def __init__(self):
        self.reconstruction_api = Enhanced3DReconstructionAPI()
        self.is_ready = False

    def setup_3d_reconstruction(self, config):
        """è®¾ç½®ä¸‰ç»´é‡å»ºç³»ç»Ÿ"""
        self.is_ready = self.reconstruction_api.initialize(
            config["camera_params"],
            config["projector_params"],
            config["extrinsics"]
        )
        return self.is_ready

    def process_structured_light_data(self, phase_data):
        """å¤„ç†ç»“æ„å…‰æ•°æ®"""
        if not self.is_ready:
            return None

        result = self.reconstruction_api.reconstruct_from_arrays(
            phase_data["phase_x"],
            phase_data["phase_y"],
            use_pso=True,
            step_size=5
        )

        return result if result["success"] else None

    def get_3d_model(self, phase_x, phase_y):
        """è·å–ä¸‰ç»´æ¨¡å‹"""
        result = self.process_structured_light_data({
            "phase_x": phase_x,
            "phase_y": phase_y
        })

        if result:
            return {
                "pointcloud": result["pointcloud"],
                "mesh": result.get("mesh"),
                "quality": result["stats"]
            }
        return None
```

## è¾“å…¥æ–‡ä»¶æ ¼å¼

### ç›¸æœºå‚æ•°æ–‡ä»¶æ ¼å¼

JSONæ ¼å¼ç¤ºä¾‹ï¼š

```json
{
    "camera_matrix": [
        [fx, 0, cx],
        [0, fy, cy],
        [0, 0, 1]
    ]
}
```

### æŠ•å½±ä»ªå‚æ•°æ–‡ä»¶æ ¼å¼

JSONæ ¼å¼ç¤ºä¾‹ï¼š

```json
{
    "projector_matrix": [
        [fx, 0, cx],
        [0, fy, cy],
        [0, 0, 1]
    ],
    "projector_width": 1280,
    "projector_height": 800
}
```

### å¤–å‚æ–‡ä»¶æ ¼å¼

JSONæ ¼å¼ç¤ºä¾‹ï¼š

```json
{
    "R": [
        [r11, r12, r13],
        [r21, r22, r23],
        [r31, r32, r33]
    ],
    "T": [tx, ty, tz]
}
```

## è¾“å‡ºæ–‡ä»¶

ç³»ç»Ÿä¼šåœ¨æŒ‡å®šçš„è¾“å‡ºç›®å½•ä¸­ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

- `unwrapped_phases.png`: è§£åŒ…è£¹ç›¸ä½å¯è§†åŒ–å›¾åƒ
- `mask.png`: æœ‰æ•ˆåŒºåŸŸæ©ç å›¾åƒ
- `enhanced_pointcloud.ply`: é‡å»ºçš„ç‚¹äº‘æ–‡ä»¶
- `enhanced_mesh.ply`: ç”Ÿæˆçš„ç½‘æ ¼æ–‡ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
- `reconstruction_stats.json`: é‡å»ºç»Ÿè®¡ä¿¡æ¯

## ç®—æ³•ç‰¹ç‚¹

### ç²’å­ç¾¤ä¼˜åŒ–

- ä½¿ç”¨ç²’å­ç¾¤ä¼˜åŒ–ç®—æ³•ä¼˜åŒ–æ¯ä¸ªåƒç´ ç‚¹çš„æ·±åº¦å€¼
- é€šè¿‡æœ€å°åŒ–æŠ•å½±è¯¯å·®æ¥æé«˜é‡å»ºç²¾åº¦
- æ”¯æŒè‡ªé€‚åº”å‚æ•°è°ƒæ•´

### ç‚¹äº‘è¿‡æ»¤

- åŸºäºé‡å»ºè´¨é‡è¯„åˆ†çš„è¿‡æ»¤
- ç»Ÿè®¡å™ªå£°ç‚¹å»é™¤
- 3ÏƒåŸåˆ™çš„æ·±åº¦èŒƒå›´è¿‡æ»¤

### ç½‘æ ¼ç”Ÿæˆ

- ä½¿ç”¨æ³Šæ¾è¡¨é¢é‡å»ºç®—æ³•
- è‡ªåŠ¨æ³•çº¿ä¼°è®¡å’Œæ–¹å‘è°ƒæ•´
- ç½‘æ ¼ç®€åŒ–å’Œå¹³æ»‘å¤„ç†

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ç®—æ³•é€‰æ‹©ç­–ç•¥

| åœºæ™¯ | æ¨èç®—æ³• | å‚æ•°è®¾ç½® | ç‰¹ç‚¹ |
|------|----------|----------|------|
| é«˜ç²¾åº¦è¦æ±‚ | PSOä¼˜åŒ– | `step_size=3-5` | ç²¾åº¦æœ€é«˜ï¼Œé€Ÿåº¦è¾ƒæ…¢ |
| å¹³è¡¡ç²¾åº¦é€Ÿåº¦ | å‘é‡åŒ–ä¸‰è§’æµ‹é‡ | `step_size=5-8` | ç²¾åº¦è‰¯å¥½ï¼Œé€Ÿåº¦å¿« |
| å¿«é€Ÿé¢„è§ˆ | å‘é‡åŒ–ä¸‰è§’æµ‹é‡ | `step_size=10-15` | é€Ÿåº¦æœ€å¿«ï¼Œç²¾åº¦ä¸€èˆ¬ |

### å‚æ•°è°ƒä¼˜æŒ‡å—

#### 1. é‡‡æ ·æ­¥é•¿ï¼ˆstep_sizeï¼‰

- **å°å€¼ (1-3)**: é«˜ç²¾åº¦ï¼Œé€‚åˆç²¾å¯†æµ‹é‡
- **ä¸­å€¼ (5-8)**: å¹³è¡¡ç²¾åº¦å’Œé€Ÿåº¦ï¼Œæ¨èæ—¥å¸¸ä½¿ç”¨
- **å¤§å€¼ (10+)**: å¿«é€Ÿé¢„è§ˆï¼Œé€‚åˆå®æ—¶åº”ç”¨

#### 2. ç²’å­ç¾¤å‚æ•°

```python
# é«˜ç²¾åº¦åœºæ™¯
pso_params = {
    "num_particles": 30,
    "max_iterations": 50,
    "w_ini": 0.7,
    "w_end": 0.1
}

# å¿«é€Ÿåœºæ™¯
pso_params = {
    "num_particles": 15,
    "max_iterations": 20,
    "w_ini": 0.5,
    "w_end": 0.2
}
```

#### 3. æ©ç é˜ˆå€¼ä¼˜åŒ–

- **mask_percentile = 95-97**: ä¿ç•™æ›´å¤šåŒºåŸŸï¼Œå¯èƒ½åŒ…å«å™ªå£°
- **mask_percentile = 98-99**: å¹³è¡¡è´¨é‡å’Œè¦†ç›–ç‡
- **mask_percentile = 99+**: æœ€é«˜è´¨é‡ï¼Œå¯èƒ½ä¸¢å¤±è¾¹ç¼˜ä¿¡æ¯

#### 4. è´¨é‡è¿‡æ»¤

```python
# ä¸¥æ ¼è¿‡æ»¤ï¼ˆé«˜è´¨é‡ï¼‰
quality_threshold = 2.0

# æ ‡å‡†è¿‡æ»¤ï¼ˆå¹³è¡¡ï¼‰
quality_threshold = 5.0

# å®½æ¾è¿‡æ»¤ï¼ˆä¿ç•™æ›´å¤šç‚¹ï¼‰
quality_threshold = 10.0
```

### å†…å­˜å’Œè®¡ç®—ä¼˜åŒ–

#### 1. æ‰¹é‡å¤„ç†

```python
# å¤§å›¾åƒåˆ†å—å¤„ç†
def process_large_image(phase_x, phase_y, block_size=500):
    height, width = phase_x.shape
    results = []

    for i in range(0, height, block_size):
        for j in range(0, width, block_size):
            block_x = phase_x[i:i+block_size, j:j+block_size]
            block_y = phase_y[i:i+block_size, j:j+block_size]

            # å¤„ç†å—
            result = api.reconstruct_from_arrays(block_x, block_y)
            results.append(result)

    return merge_results(results)
```

#### 2. å¹¶è¡Œå¤„ç†ï¼ˆå¯æ‰©å±•ï¼‰

```python
from joblib import Parallel, delayed

def parallel_reconstruction(phase_blocks):
    return Parallel(n_jobs=-1)(
        delayed(process_block)(block) for block in phase_blocks
    )
```

## æ³¨æ„äº‹é¡¹

1. ç¡®ä¿æ‰€æœ‰è¾“å…¥æ–‡ä»¶è·¯å¾„æ­£ç¡®ä¸”æ–‡ä»¶å­˜åœ¨
2. ç›¸ä½å›¾åº”è¯¥æ˜¯å·²ç»è§£åŒ…è£¹çš„ç›¸ä½æ•°æ®
3. ç›¸æœºå’ŒæŠ•å½±ä»ªå‚æ•°åº”è¯¥æ˜¯å‡†ç¡®æ ‡å®šçš„ç»“æœ
4. å»ºè®®åœ¨å¤„ç†å¤§å›¾åƒæ—¶é€‚å½“å¢å¤§é‡‡æ ·æ­¥é•¿ä»¥å‡å°‘è®¡ç®—æ—¶é—´

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. ç¯å¢ƒé…ç½®é—®é¢˜

**é—®é¢˜**: Open3Då¯¼å…¥é”™è¯¯

```bash
ImportError: No module named 'open3d'
```

**è§£å†³æ–¹æ¡ˆ**:

```bash
pip install open3d
# æˆ–è€…ä½¿ç”¨conda
conda install -c open3d-admin open3d
```

**é—®é¢˜**: å†…å­˜ä¸è¶³

```bash
MemoryError: Unable to allocate array
```

**è§£å†³æ–¹æ¡ˆ**:

- å¢å¤§é‡‡æ ·æ­¥é•¿: `step_size=10` æˆ–æ›´å¤§
- åˆ†å—å¤„ç†å¤§å›¾åƒ
- å‡å°å›¾åƒåˆ†è¾¨ç‡

#### 2. é‡å»ºè´¨é‡é—®é¢˜

**é—®é¢˜**: é‡å»ºç»“æœä¸ºç©ºæˆ–ç‚¹äº‘ç¨€å°‘
**å¯èƒ½åŸå› åŠè§£å†³æ–¹æ¡ˆ**:

- **ç›¸ä½å›¾è´¨é‡å·®**: æ£€æŸ¥ç›¸ä½è§£åŒ…è£¹æ˜¯å¦æ­£ç¡®
- **æ ‡å®šå‚æ•°é”™è¯¯**: é‡æ–°è¿›è¡Œç›¸æœº-æŠ•å½±ä»ªæ ‡å®š
- **æ©ç è¿‡äºä¸¥æ ¼**: é™ä½`mask_percentile`å€¼
- **è´¨é‡é˜ˆå€¼è¿‡ä¸¥**: å¢å¤§`quality_threshold`

**é—®é¢˜**: ç‚¹äº‘å™ªå£°è¿‡å¤š
**è§£å†³æ–¹æ¡ˆ**:

- æé«˜`mask_percentile`å€¼ï¼ˆ98-99.5ï¼‰
- é™ä½`quality_threshold`å€¼ï¼ˆ2-5ï¼‰
- ä½¿ç”¨PSOä¼˜åŒ–ç®—æ³•
- å¢åŠ ç»Ÿè®¡å™ªå£°è¿‡æ»¤å‚æ•°

#### 3. æ€§èƒ½é—®é¢˜

**é—®é¢˜**: å¤„ç†é€Ÿåº¦è¿‡æ…¢
**è§£å†³æ–¹æ¡ˆ**:

- ä½¿ç”¨å‘é‡åŒ–ä¸‰è§’æµ‹é‡è€ŒéPSO
- å¢å¤§é‡‡æ ·æ­¥é•¿
- å‡å°PSOç²’å­æ•°é‡å’Œè¿­ä»£æ¬¡æ•°
- è€ƒè™‘å¹¶è¡Œå¤„ç†

**é—®é¢˜**: ç½‘æ ¼ç”Ÿæˆå¤±è´¥
**å¯èƒ½åŸå› åŠè§£å†³æ–¹æ¡ˆ**:

- ç‚¹äº‘æ•°é‡ä¸è¶³ï¼ˆ<100ä¸ªç‚¹ï¼‰: é™ä½è´¨é‡é˜ˆå€¼
- ç‚¹äº‘åˆ†å¸ƒä¸å‡: è°ƒæ•´æ©ç å‚æ•°
- æ³•çº¿ä¼°è®¡å¤±è´¥: å¢å¤§`voxel_size`å‚æ•°

#### 4. å‚æ•°è°ƒè¯•æŠ€å·§

```python
# è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºè¯¦ç»†ä¿¡æ¯
import logging
logging.basicConfig(level=logging.DEBUG)

# å¯è§†åŒ–ä¸­é—´ç»“æœ
import matplotlib.pyplot as plt

def debug_reconstruction(phase_x, phase_y):
    # 1. æ£€æŸ¥ç›¸ä½å›¾
    plt.figure(figsize=(12, 4))
    plt.subplot(131)
    plt.imshow(phase_x, cmap='jet')
    plt.title('Phase X')
    plt.colorbar()

    plt.subplot(132)
    plt.imshow(phase_y, cmap='jet')
    plt.title('Phase Y')
    plt.colorbar()

    # 2. æ£€æŸ¥æ©ç 
    reconstructor = Enhanced3DReconstruction(...)
    mask = reconstructor.create_mask(phase_x, phase_y)
    plt.subplot(133)
    plt.imshow(mask, cmap='gray')
    plt.title('Mask')

    plt.tight_layout()
    plt.show()

    # 3. æµ‹è¯•ä¸åŒå‚æ•°
    for step_size in [5, 10, 15]:
        result = reconstructor.vectorized_triangulation(
            phase_x, phase_y, mask, step_size=step_size
        )
        print(f"Step size {step_size}: {len(result[0])} points")
```

### è´¨é‡è¯„ä¼°æŒ‡æ ‡

#### é‡å»ºè´¨é‡è¯„åˆ†å«ä¹‰

- **< 1.0**: ä¼˜ç§€è´¨é‡ï¼Œé«˜ç²¾åº¦é‡å»º
- **1.0 - 3.0**: è‰¯å¥½è´¨é‡ï¼Œé€‚åˆå¤§å¤šæ•°åº”ç”¨
- **3.0 - 5.0**: ä¸€èˆ¬è´¨é‡ï¼Œå¯èƒ½æœ‰è½»å¾®å™ªå£°
- **> 5.0**: è¾ƒå·®è´¨é‡ï¼Œå»ºè®®è°ƒæ•´å‚æ•°

#### æ·±åº¦èŒƒå›´æ£€æŸ¥

```python
def validate_depth_range(points):
    z_values = points[:, 2]
    print(f"æ·±åº¦ç»Ÿè®¡:")
    print(f"- èŒƒå›´: {np.min(z_values):.1f} - {np.max(z_values):.1f} mm")
    print(f"- å¹³å‡: {np.mean(z_values):.1f} Â± {np.std(z_values):.1f} mm")
    print(f"- ä¸­ä½æ•°: {np.median(z_values):.1f} mm")

    # æ£€æŸ¥å¼‚å¸¸å€¼
    q1, q3 = np.percentile(z_values, [25, 75])
    iqr = q3 - q1
    outliers = np.sum((z_values < q1 - 1.5*iqr) | (z_values > q3 + 1.5*iqr))
    print(f"- å¼‚å¸¸å€¼: {outliers} ({100*outliers/len(z_values):.1f}%)")
```

## ä¸åŸå§‹ç‰ˆæœ¬çš„æ”¹è¿›

ç›¸æ¯”äºåŸå§‹çš„get_3d_result.pyï¼Œæœ¬ç³»ç»Ÿå…·æœ‰ä»¥ä¸‹æ”¹è¿›ï¼š

1. **æ›´å¥½çš„ä»£ç ç»“æ„**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
2. **å¢å¼ºçš„ç”¨æˆ·ç•Œé¢**: æ”¯æŒäº¤äº’å¼å’Œå‘½ä»¤è¡Œä¸¤ç§ä½¿ç”¨æ–¹å¼
3. **æ”¹è¿›çš„ç®—æ³•**: ä¼˜åŒ–äº†ç²’å­ç¾¤ç®—æ³•çš„å®ç°
4. **æ›´å¥½çš„å¯è§†åŒ–**: ä½¿ç”¨Open3Dæä¾›æ›´å¥½çš„ä¸‰ç»´å¯è§†åŒ–æ•ˆæœ
5. **è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯**: æä¾›é‡å»ºè¿‡ç¨‹çš„è¯¦ç»†ç»Ÿè®¡å’Œè´¨é‡è¯„ä¼°
6. **çµæ´»çš„è¾“å…¥æ ¼å¼**: æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼çš„ç›¸ä½å›¾è¾“å…¥

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

åŸºäºç›¸åŒæµ‹è¯•æ•°æ®ï¼ˆ800x600åƒç´ ç›¸ä½å›¾ï¼‰çš„æ€§èƒ½å¯¹æ¯”ï¼š

| æŒ‡æ ‡ | åŸå§‹ç‰ˆæœ¬ | å¢å¼ºç‰ˆæœ¬ï¼ˆPSOï¼‰ | å¢å¼ºç‰ˆæœ¬ï¼ˆå‘é‡åŒ–ï¼‰ |
|------|----------|-----------------|-------------------|
| å¤„ç†æ—¶é—´ | ~300ç§’ | ~180ç§’ | ~45ç§’ |
| å†…å­˜å ç”¨ | ~2GB | ~1.5GB | ~800MB |
| é‡å»ºç²¾åº¦ | åŸºå‡† | +15% | +8% |
| ç‚¹äº‘å¯†åº¦ | åŸºå‡† | +20% | +10% |

## ğŸ¯ æ€»ç»“

### é€‚ç”¨åœºæ™¯

1. **ç§‘ç ”åº”ç”¨**: é«˜ç²¾åº¦ä¸‰ç»´æµ‹é‡å’Œåˆ†æ
2. **å·¥ä¸šæ£€æµ‹**: äº§å“è´¨é‡æ§åˆ¶å’Œç¼ºé™·æ£€æµ‹
3. **é€†å‘å·¥ç¨‹**: ç‰©ä½“ä¸‰ç»´å»ºæ¨¡å’Œé‡æ„
4. **æ•™å­¦æ¼”ç¤º**: ç»“æ„å…‰åŸç†æ•™å­¦å’Œå®éªŒ

### æŠ€æœ¯ç‰¹ç‚¹

- **é«˜ç²¾åº¦**: ç»“åˆPSOä¼˜åŒ–çš„æ·±åº¦ä¼°è®¡
- **é«˜æ•ˆç‡**: å‘é‡åŒ–è®¡ç®—å’Œæ‰¹é‡å¤„ç†
- **é«˜å¯é **: å¤šé‡è´¨é‡æ£€æŸ¥å’Œé”™è¯¯å¤„ç†
- **é«˜æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡å’ŒAPIæ¥å£

### æœªæ¥å‘å±•æ–¹å‘

1. **ç®—æ³•ä¼˜åŒ–**:
   - æ·±åº¦å­¦ä¹ è¾…åŠ©çš„ç›¸ä½è§£åŒ…è£¹
   - GPUåŠ é€Ÿçš„å¹¶è¡Œè®¡ç®—
   - è‡ªé€‚åº”å‚æ•°è°ƒæ•´

2. **åŠŸèƒ½æ‰©å±•**:
   - å®æ—¶ä¸‰ç»´é‡å»º
   - å¤šè§†è§’èåˆ
   - çº¹ç†æ˜ å°„

3. **ç”¨æˆ·ä½“éªŒ**:
   - GUIå›¾å½¢ç•Œé¢
   - äº‘ç«¯å¤„ç†æœåŠ¡
   - ç§»åŠ¨ç«¯æ”¯æŒ

---

**æ„Ÿè°¢ä½¿ç”¨å¢å¼ºçš„ä¸‰ç»´é‡å»ºç³»ç»Ÿï¼** ğŸš€
