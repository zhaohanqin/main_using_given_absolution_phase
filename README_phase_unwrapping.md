# 三频外差法相位解包裹测试程序使用说明

## 一、程序功能介绍

本测试程序`phase_unwrapping_test.py`实现了基于三频外差法的相位解包裹功能，可以处理结构光三维成像系统中的相移条纹图像，生成展开后的绝对相位图。该程序是结构光三维重建系统的重要组成部分，通过处理相移图像获取物体表面的相位信息，为后续的三维点云重建提供基础数据。

## 二、图像准备要求

### 1. 图像数量与命名

程序需要处理**24张**相移图像，具体包括：

- 3个频率（高、中、低）
- 每个频率4张相移图像（相位偏移为0°, 90°, 180°, 270°）
- 2个方向（水平条纹和垂直条纹）

图像文件应当按照**数字顺序命名**，例如：`1.jpg`, `2.jpg`, ..., `24.jpg`，程序将按照以下顺序处理这些图像：

1. 图像1-4：水平条纹高频相移图像（用于解算垂直方向相位）
2. 图像5-8：水平条纹中频相移图像（用于解算垂直方向相位）
3. 图像9-12：水平条纹低频相移图像（用于解算垂直方向相位）
4. 图像13-16：垂直条纹高频相移图像（用于解算水平方向相位）
5. 图像17-20：垂直条纹中频相移图像（用于解算水平方向相位）
6. 图像21-24：垂直条纹低频相移图像（用于解算水平方向相位）

> **重要说明**：条纹方向与解相位方向的关系
>
> - 水平条纹（相位沿Y方向变化）用于解算垂直方向的相位
> - 垂直条纹（相位沿X方向变化）用于解算水平方向的相位
>
> 这是因为相位变化的方向决定了解相位的方向，而不是条纹延伸的方向。

### 2. 图像格式与要求

- 支持常见图像格式：JPG, PNG, BMP等
- 所有图像尺寸应相同
- 图像应为灰度图或能转换为灰度图的彩色图像
- 图像应具有良好的对比度，以确保相位计算准确性

### 3. 拍摄建议

拍摄相移图像时，请注意以下事项：

- 保持相机和投影仪位置固定不变
- 确保被测物体在拍摄过程中不发生移动
- 尽量避免环境光干扰，最好在暗室环境下进行
- 投影仪亮度适中，既要保证条纹清晰可见，又不能导致过曝

## 三、程序使用方法

### 1. 运行环境

程序依赖以下Python库：

- NumPy
- OpenCV (cv2)
- Matplotlib
- PIL (Python Imaging Library)
- argparse

可以使用以下命令安装依赖：

```bash
pip install numpy opencv-python matplotlib pillow argparse
```

### 2. 命令行参数

程序支持以下命令行参数：

- `--input_dir`：**必选参数**，包含相移图像的文件夹路径
- `--output_dir`：可选参数，结果输出文件夹路径，默认为`./output`
- `--show_results`：可选参数，是否显示结果图像，默认不显示

### 3. 运行示例

```bash
# 基本用法
python phase_unwrapping_test.py --input_dir ./phase_images

# 指定输出目录并显示结果
python phase_unwrapping_test.py --input_dir ./phase_images --output_dir ./results --show_results
```

### 4. 生成测试图像

您可以使用`generate_test_images.py`脚本生成测试用的相移条纹图像：

```bash
# 基本用法
python generate_test_images.py --output_dir ./test_images

# 显示预览图像
python generate_test_images.py --output_dir ./test_images --show_preview

# 指定图像尺寸
python generate_test_images.py --output_dir ./test_images --width 1280 --height 720
```

生成的图像将按照正确的顺序命名，可以直接用于相位解包裹测试。

## 四、输出结果说明

程序会在指定的输出目录生成以下文件：

1. `unwrapped_phase_vertical.tiff`：垂直方向展开的绝对相位图
2. `unwrapped_phase_horizontal.tiff`：水平方向展开的绝对相位图
3. `phase_quality.tiff`：相位质量图，表示相位可靠性
4. `phase_visualization.png`：三张图的可视化结果（仅当使用`--show_results`参数时生成）

这些相位图可以用于后续的三维重建过程，例如与`get_3d_result.py`结合使用，生成三维点云数据。

## 五、常见问题与解决方法

1. **图像读取失败**
   - 检查文件路径是否正确
   - 确认图像格式是否受支持
   - 检查图像文件命名是否符合要求（应为纯数字）

2. **相位图质量不佳**
   - 检查相移图像的质量，确保条纹清晰可见
   - 调整频率参数（fx和fy）以适应您的实验设置
   - 尝试改变初始相位偏移量（ph0）

3. **程序运行缓慢**
   - 减小图像分辨率可以提高处理速度
   - 对于大尺寸图像，可以考虑使用图像金字塔或区域处理

4. **相位跳变错误**
   - 这通常是由于频率选择不当导致的
   - 确保三个频率之间有合适的比例关系
   - 典型的频率组合如[64, 8, 1]或[81, 9, 1]

5. **条纹方向与解相位方向不匹配**
   - 记住：水平条纹用于解算垂直方向相位，垂直条纹用于解算水平方向相位
   - 如果发现相位图方向错误，可能是图像顺序有问题

## 六、参数调整建议

程序中的一些关键参数可能需要根据您的具体实验设置进行调整：

1. **频率参数（fx和fy）**
   - 这些参数应与投影的条纹频率相匹配
   - 频率值应从高到低排序
   - 高频提供精细细节，低频确保正确解包裹

2. **相移步数（phase_step）**
   - 默认为4，对应于4步相移（0°, 90°, 180°, 270°）
   - 如果使用3步相移，需要修改此参数为3

3. **初始相位偏移（ph0）**
   - 默认为0.5，可根据实际情况调整
   - 这个参数影响相位的零点位置

通过适当调整这些参数，可以获得最佳的相位解包裹效果。
