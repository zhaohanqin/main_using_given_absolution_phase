# 三频外差投影仪标定程序

## 概述

本程序提供了基于三频外差相位解包裹技术的投影仪标定功能，包含命令行版本和图形用户界面版本。

## 功能特点

- **三频外差相位解包裹**：使用三个不同频率的正弦条纹进行相位解包裹
- **高精度标定**：支持投影仪内参和外参的精确标定
- **多种标定板**：支持棋盘格、圆点和环形圆点标定板
- **图形界面**：提供直观的GUI操作界面
- **结果可视化**：实时显示相位图和标定结果
- **多格式支持**：支持NPZ和JSON格式的参数文件

## 文件说明

- `projector_calibration_three_freq.py` - 命令行版本标定程序
- `projector_calibration_three_freq_gui.py` - GUI版本标定程序
- `test_calibration_programs.py` - 程序功能测试脚本
- `README.md` - 本说明文档

## 环境要求

### 必需依赖

- Python 3.7+
- OpenCV (cv2) >= 4.0
- NumPy >= 1.19
- Matplotlib >= 3.0

### GUI版本额外依赖

- PySide6 >= 6.0

### 可选依赖

- tqdm (用于显示进度条)

## 安装依赖

```bash
pip install opencv-python numpy matplotlib PySide6 tqdm
```

## 使用方法

### 1. 准备数据

#### 相机标定文件

首先需要完成相机标定，获得相机内参和畸变系数。支持以下格式：

**NPZ格式** (推荐):

```python
np.savez('camera_params.npz', 
         camera_matrix=camera_matrix, 
         dist_coeffs=dist_coeffs)
```

**JSON格式**:

```json
{
  "camera_matrix": [[fx, 0, cx], [0, fy, cy], [0, 0, 1]],
  "dist_coeffs": [k1, k2, p1, p2, k3]
}
```

#### 相移图像数据

需要准备包含24张相移图像的数据，按以下结构组织：

```bash
phase_images/
├── pose_01/          # 第一个标定姿态
│   ├── I01.png      # 水平高频相移图像 1 (相位 0°)
│   ├── I02.png      # 水平高频相移图像 2 (相位 90°)
│   ├── I03.png      # 水平高频相移图像 3 (相位 180°)
│   ├── I04.png      # 水平高频相移图像 4 (相位 270°)
│   ├── I05.png      # 水平中频相移图像 1 (相位 0°)
│   ├── I06.png      # 水平中频相移图像 2 (相位 90°)
│   ├── I07.png      # 水平中频相移图像 3 (相位 180°)
│   ├── I08.png      # 水平中频相移图像 4 (相位 270°)
│   ├── I09.png      # 水平低频相移图像 1 (相位 0°)
│   ├── I10.png      # 水平低频相移图像 2 (相位 90°)
│   ├── I11.png      # 水平低频相移图像 3 (相位 180°)
│   ├── I12.png      # 水平低频相移图像 4 (相位 270°)
│   ├── I13.png      # 垂直高频相移图像 1 (相位 0°)
│   ├── I14.png      # 垂直高频相移图像 2 (相位 90°)
│   ├── I15.png      # 垂直高频相移图像 3 (相位 180°)
│   ├── I16.png      # 垂直高频相移图像 4 (相位 270°)
│   ├── I17.png      # 垂直中频相移图像 1 (相位 0°)
│   ├── I18.png      # 垂直中频相移图像 2 (相位 90°)
│   ├── I19.png      # 垂直中频相移图像 3 (相位 180°)
│   ├── I20.png      # 垂直中频相移图像 4 (相位 270°)
│   ├── I21.png      # 垂直低频相移图像 1 (相位 0°)
│   ├── I22.png      # 垂直低频相移图像 2 (相位 90°)
│   ├── I23.png      # 垂直低频相移图像 3 (相位 180°)
│   └── I24.png      # 垂直低频相移图像 4 (相位 270°)
├── pose_02/          # 第二个标定姿态
│   ├── I01.png      # 同样的24张图像，但标定板位置不同
│   ├── I02.png
│   ├── ...
│   └── I24.png
├── pose_03/          # 第三个标定姿态
│   └── ...
└── pose_N/           # 第N个标定姿态 (建议至少5-10个姿态)
    └── ...
```

**重要说明**：

1. **姿态要求**：
   - 至少需要3个不同的标定板姿态，建议5-10个姿态
   - 每个姿态中标定板的位置和角度都应该不同
   - 标定板应覆盖投影仪和相机的视野范围
   - 姿态之间应有足够的差异以确保标定精度

2. **图像顺序说明**：
   - I01-I04: 水平方向高频条纹 (4步相移: 0°, 90°, 180°, 270°)
   - I05-I08: 水平方向中频条纹 (4步相移: 0°, 90°, 180°, 270°)
   - I09-I12: 水平方向低频条纹 (4步相移: 0°, 90°, 180°, 270°)
   - I13-I16: 垂直方向高频条纹 (4步相移: 0°, 90°, 180°, 270°)
   - I17-I20: 垂直方向中频条纹 (4步相移: 0°, 90°, 180°, 270°)
   - I21-I24: 垂直方向低频条纹 (4步相移: 0°, 90°, 180°, 270°)

3. **频率设置**：
   - 高频：71条纹 (用于精确测量)
   - 中频：64条纹 (用于外差解包裹)
   - 低频：58条纹 (用于外差解包裹)
   - 频率值可根据投影仪分辨率调整

4. **拍摄要求**：
   - 每个姿态都需要拍摄完整的24张相移图像
   - 在拍摄过程中保持标定板和相机位置固定
   - 确保投影条纹清晰可见，避免过曝或欠曝
   - 标定板应在相机和投影仪的共同视野内

### 2. 命令行版本使用

```bash
python projector_calibration_three_freq.py \
    --camera_params camera_calibration.npz \
    --phase_images ./phase_images \
    --projector_width 1024 \
    --projector_height 768 \
    --board_type chessboard \
    --chessboard_width 9 \
    --chessboard_height 6 \
    --square_size 20.0 \
    --frequencies 71 64 58 \
    --output_folder ./results
```

#### 主要参数说明

- `--camera_params`: 相机标定参数文件路径
- `--phase_images`: 相移图像文件夹路径
- `--projector_width/height`: 投影仪分辨率
- `--board_type`: 标定板类型 (chessboard/circles/ring_circles)
- `--chessboard_width/height`: 标定板内角点数量
- `--square_size`: 标定板方格尺寸 (mm)
- `--frequencies`: 三个频率值 (从高到低)
- `--phase_step`: 相移步数 (默认4)
- `--ph0`: 初始相位偏移 (默认0.5)
- `--quality_threshold`: 相位质量阈值 (默认0.3)

### 3. GUI版本使用

```bash
python projector_calibration_three_freq_gui.py
```

GUI界面包含以下功能区域：

1. **参数设置面板**：
   - 文件路径设置
   - 投影仪参数
   - 标定板参数
   - 三频外差参数

2. **结果显示面板**：
   - 处理日志
   - 相位图显示
   - 标定结果

3. **操作按钮**：
   - 开始标定
   - 取消标定

## 输出结果

标定完成后会生成以下文件：

- `three_freq_projector_calibration.npz` - 标定结果 (NPZ格式)
- `three_freq_projector_calibration.json` - 标定结果 (JSON格式)
- `three_freq_unwrapped_vertical.png` - 垂直方向解包裹相位图
- `three_freq_unwrapped_horizontal.png` - 水平方向解包裹相位图
- `three_freq_quality_map.png` - 相位质量图

### 标定结果包含

- `projector_matrix`: 投影仪内参矩阵 (3x3)
- `projector_dist`: 投影仪畸变系数
- `R`: 投影仪到相机的旋转矩阵 (3x3)
- `T`: 投影仪到相机的平移向量 (3x1)
- `reprojection_error`: 重投影误差 (像素)

## 标定质量评估

程序会自动评估标定质量：

- **重投影误差 < 0.5像素**: 极佳
- **重投影误差 < 1.0像素**: 良好
- **重投影误差 < 2.0像素**: 一般
- **重投影误差 >= 2.0像素**: 较差

## 故障排除

### 常见问题

1. **"未能检测到标定板"**
   - 检查标定板是否在图像中清晰可见
   - 确认标定板参数设置正确
   - 尝试改善照明条件

2. **"相位质量不足"**
   - 调整质量阈值参数
   - 检查投影条纹是否清晰
   - 确保相移图像质量良好

3. **"对应点数量不足"**
   - 增加标定姿态数量
   - 确保每个姿态都有足够的有效角点
   - 检查相位解包裹结果

4. **"重投影误差过大"**
   - 增加标定图像数量
   - 改善图像质量
   - 检查标定板平整度
   - 重新进行相机标定

## 测试程序

运行测试脚本验证程序功能：

```bash
python test_calibration_programs.py
```

测试内容包括：

- 模块导入测试
- 相机参数加载测试
- 三频相位处理测试
- 标定配置测试

## 技术原理

### 三频外差法

本程序采用三频外差相位解包裹技术：

1. **相位计算**：使用4步相移算法计算包裹相位
2. **频率设计**：选择三个合适的频率值 (如71, 64, 58)
3. **外差解包裹**：利用频率差进行相位解包裹
4. **质量评估**：基于调制度计算相位质量

### 标定流程

1. 加载相机标定参数
2. 处理各姿态的相移图像
3. 执行三频相位解包裹
4. 检测标定板角点
5. 建立投影仪-相机对应关系
6. 执行立体标定
7. 输出标定结果

## 版本信息

- 版本: 1.0
- 更新日期: 2024年
- 作者: [Your Name]

## 许可证

本程序遵循相应的开源许可证。
